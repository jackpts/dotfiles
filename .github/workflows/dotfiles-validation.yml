name: Dotfiles Validation

on: [push, pull_request]

jobs:
  validate:
    runs-on: ubuntu-latest
    container: archlinux:latest

    steps:
      - name: Install system dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --needed --noconfirm \
            git stow fish zsh bash \
            nodejs npm python \
            neovim lua54 tmux kitty \
            xorg-server-xwayland  # for compatibility

      - name: Checkout dotfiles
        uses: actions/checkout@v4

      # Format check: YAML + JSON
        run: |
          pacman -S --noconfirm python-yaml
          pip install yamllint

      - name: Validate YAML files
        run: |
          yamllint . --format parsable --strict || true  # --strict can be too severe

      - name: Validate JSON files
        run: |
          find . -name "*.json" -type f -exec python -m json.tool {} \; > /dev/null

      - name: Validate scripts/ directory
        run: |
          if [ -d "scripts" ]; then
            find scripts -type f -name "*.sh" -exec bash -n {} \;
          fi

      - name: Validate stow structure
        run: |
          for pkg in */; do
            if [[ -d "$pkg" && "$pkg" != ".github/" && "$pkg" != ".git/" ]]; then
              echo "Checking stow package: $pkg"
              stow --no --target=/tmp/stow-test --dir="$PWD" --simulate "$(basename "$pkg")"
            fi
          done
